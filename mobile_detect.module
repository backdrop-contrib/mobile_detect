<?php

/**
 * @file
 * Lightweight mobile detection based on the Mobile_Detect.php library.
 */

/**
 * Implements hook_registry_files_alter().
 *
 * Adds the Mobile_Detect() class to the registry so that autoloading works.
 * See http://drupal.stackexchange.com/questions/42266 for a discussion.
 */
function mobile_detect_registry_files_alter(&$files, $modules) {
  $library_path = _mobile_detect_get_library_path();

  $files[$library_path . '/Mobile_Detect.php'] = array(
    'module' => 'mobile_detect',
    'weight' => 0,
  );
}

/**
 * Getter function to retrieve a Mobile_Detect() singleton.
 */
function mobile_detect_get_object() {
  $detect = &drupal_static(__FUNCTION__);

  if (!isset($detect)) {
    try {
      $detect = new Mobile_Detect();
    } catch (Exception $e) {
      $detect = NULL;
      watchdog('mobile_detect', 'Could instantiate Mobile_Detect(): %message',
        array('%message' => $e->getMessage()), WATCHDOG_ALERT);
    }
  }

  return $detect;
}

/**
 * Retrieve the path to the Mobile_Detect library.
 */
function _mobile_detect_get_library_path() {
  if (function_exists('libraries_get_path')) {
    $library_path = libraries_get_path('Mobile_Detect');
    if (!$library_path) {
      $library_path = 'sites/all/libraries/Mobile_Detect';
    }
  }
  else {
    $library_path = 'sites/all/libraries/Mobile_Detect';
  }

  return $library_path;
}
